<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver App - Daftar Order</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding-bottom: 80px;
        }
        
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .order-list {
            padding: 15px;
        }
        
        .order-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .profile-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .order-info {
            flex: 1;
        }
        
        .user-name {
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .pickup-address {
            font-weight: bold;
            margin-bottom: 8px;
            color: #222;
        }
        
        .order-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            padding: 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: 80vh;
            overflow-y: auto;
            touch-action: none;
        }
        
        .bottom-sheet.active {
            transform: translateY(0);
        }
        
        .map-container {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .sheet-header {
            display: flex;
            margin-bottom: 15px;
        }
        
        .sheet-profile {
            margin-right: 15px;
            text-align: center;
        }
        
        .sheet-profile-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .sheet-details {
            flex: 1;
        }
        
        .address {
            margin-bottom: 5px;
        }
        
        .pickup {
            font-weight: bold;
        }
        
        .phone {
            color: #4CAF50;
            margin-top: 5px;
        }
        
        .sheet-meta {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        .button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        
        .accept-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .distance-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .no-orders {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error-message {
            color: #f44336;
            text-align: center;
            padding: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Daftar Order</h1>
    </div>
    
    <!-- Elemen order list yang diperlukan -->
    <div class="order-list" id="orderList">
        <div class="loading">Memuat order...</div>
    </div>
    
    <!-- Bottom sheet dengan semua elemen yang diperlukan -->
    <div class="bottom-sheet" id="bottomSheet">
        <div class="map-container" id="mapContainer"></div>
        
        <div class="sheet-header">
            <div class="sheet-profile">
                <img id="sheetPhoto" class="sheet-profile-photo" src="" alt="Profile">
                <div id="sheetName" class="user-name"></div>
            </div>
            <div class="sheet-details">
                <div class="address pickup" id="sheetFrom"></div>
                <div class="address" id="sheetTo"></div>
                <div class="phone" id="sheetPhone"></div>
            </div>
        </div>
        
        <div class="sheet-meta">
            <div>
                <div style="font-size: 12px; color: #666;">Jarak</div>
                <div id="sheetDistance"></div>
            </div>
            <div>
                <div style="font-size: 12px; color: #666;">Durasi</div>
                <div id="sheetDuration"></div>
            </div>
            <div>
                <div style="font-size: 12px; color: #666;">Harga</div>
                <div id="sheetPrice"></div>
            </div>
        </div>
        
        <div class="button-group">
            <button class="button cancel-btn" id="cancelBtn">Batalkan</button>
            <button class="button accept-btn" id="acceptBtn">Ambil Order</button>
        </div>
    </div>

    <script>
        // Fungsi init akan dipanggil saat halaman selesai dimuat
        function init() {
            console.log("Aplikasi mulai diinisialisasi...");
            
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const firebaseConfigParam = urlParams.get('firebaseConfig');
            const mapKey = urlParams.get('mapKey');
            
            if (!firebaseConfigParam || !mapKey) {
                const errorMsg = !firebaseConfigParam && !mapKey 
                    ? "Parameter firebaseConfig dan mapKey tidak ditemukan di URL." 
                    : !firebaseConfigParam 
                        ? "Parameter firebaseConfig tidak ditemukan di URL." 
                        : "Parameter mapKey tidak ditemukan di URL.";
                
                document.getElementById('orderList').innerHTML = `
                    <div class="error-message">${errorMsg}</div>
                `;
                console.error(errorMsg);
                return;
            }
            
            try {
                // Initialize Firebase
                const firebaseConfig = JSON.parse(decodeURIComponent(firebaseConfigParam));
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("Firebase berhasil diinisialisasi");
                }
                
                const database = firebase.database();
                
                // Start watching position
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        position => {
                            currentPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            console.log("Posisi driver diperbarui:", currentPosition);
                            checkDistanceToOrders();
                        },
                        error => {
                            console.error('Error getting location:', error);
                            loadOrders(); // Tetap load orders meski geolocation error
                        },
                        { 
                            enableHighAccuracy: true,
                            maximumAge: 30000,
                            timeout: 10000 
                        }
                    );
                } else {
                    console.error('Geolocation is not supported by this browser.');
                    loadOrders();
                }
                
                // Set up Firebase listener
                loadOrders();
                
                // Set up event listeners
                document.getElementById('cancelBtn').addEventListener('click', closeBottomSheet);
                document.getElementById('acceptBtn').addEventListener('click', acceptOrder);
                
                // Mencegah scroll pada bottom sheet
                document.getElementById('bottomSheet').addEventListener('touchmove', function(e) {
                    e.preventDefault();
                }, { passive: false });
                
            } catch (error) {
                console.error("Error inisialisasi:", error);
                document.getElementById('orderList').innerHTML = `
                    <div class="error-message">Gagal menginisialisasi aplikasi: ${error.message}</div>
                `;
            }
        }
        
        // Panggil init saat halaman selesai dimuat
        window.onload = init;
        
        // Variabel global
        let currentPosition = null;
        let currentOrder = null;
        
        // Fungsi-fungsi lainnya (loadOrders, renderOrders, checkDistanceToOrders, dll)
        // ... (sama seperti di contoh sebelumnya) ...
        
    </script>
</body>
</html>
