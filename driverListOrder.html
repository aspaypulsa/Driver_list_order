<!DOCTYPE html><html>
<head>
  <meta charset="UTF-8">
  <title>Daftar Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f2f2f2; }
    .order-list { padding: 1em; }
    .order-card {
      background: white; border-radius: 12px; padding: 1em; margin-bottom: 1em;
      display: flex; align-items: flex-start; gap: 1em; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .order-card img {
      width: 64px; height: 64px; border-radius: 50%; object-fit: cover;
    }
    .order-info { flex: 1; }
    .order-info .nama { font-weight: bold; font-size: 1em; margin-top: 0.5em; }
    .order-info .alamat { font-weight: bold; font-size: 0.9em; }
    .order-footer { display: flex; justify-content: space-between; margin-top: 0.5em; font-size: 0.9em; }
    .bottom-sheet {
      position: fixed; left: 0; right: 0; bottom: 0; background: white;
      border-radius: 20px 20px 0 0; padding: 1em; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      display: none; z-index: 10;
    }
    .map-container { width: 100%; height: 300px; border-radius: 12px; overflow: hidden; margin-bottom: 1em; }
    .order-header { display: flex; align-items: center; gap: 1em; margin-bottom: 1em; }
    .order-header img { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; }
    .order-header .nama { font-weight: bold; font-size: 1em; }
    .order-detail p { margin: 0.3em 0; }
    .order-detail .from { font-weight: bold; }
    .order-summary { display: flex; justify-content: space-between; margin-top: 1em; font-size: 0.95em; }
    .button-group { display: flex; justify-content: space-between; gap: 1em; margin-top: 1em; }
    .button-group button {
      flex: 1; padding: 0.6em; border: none; border-radius: 6px; font-weight: bold;
    }
    .btn-batal { background: #dc3545; color: white; }
    .btn-ambil { background: #28a745; color: white; }
  </style>
</head>
<body>
  <div class="order-list" id="orderList">Memuat order...</div>  <div class="bottom-sheet" id="bottomSheet">
    <div class="map-container">
      <iframe id="mapFrame" width="100%" height="100%" style="border:0" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
    <div class="order-header">
      <img id="fotoPenumpang" src="" alt="Foto Penumpang">
      <div class="nama" id="namaPenumpang"></div>
    </div>
    <div class="order-detail" id="sheetContent"></div>
    <div class="order-summary" id="ringkasanOrder"></div>
    <div class="button-group">
      <button class="btn-batal" onclick="batalkanOrder()">Batalkan</button>
      <button class="btn-ambil" onclick="ambilOrder()">Ambil Order</button>
    </div>
  </div>  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>  <script>
    const params = new URLSearchParams(location.search);
    const mapKey = params.get('mapKey');
    const config = JSON.parse(decodeURIComponent(params.get('firebaseConfig')));
    firebase.initializeApp(config);
    const db = firebase.database();

    let lokasiDriver = null;
    let orderDipilih = null;
    let currentMapUrl = "";
    let orderDibatalkan = new Set();

    navigator.geolocation.watchPosition(pos => {
      lokasiDriver = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      muatOrder();
    });

    function haversine(lat1, lng1, lat2, lng2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function muatOrder() {
      if (!lokasiDriver) return;

      db.ref('orders').once('value', snap => {
        const data = snap.val();
        const orderList = document.getElementById('orderList');
        orderList.innerHTML = '';
        for (const id in data) {
          const o = data[id];
          if (o.status !== 'pending' || orderDibatalkan.has(id)) continue;

          const [latJemput, lngJemput] = o.from_latlng.split(',').map(Number);
          const jarak = haversine(lokasiDriver.lat, lokasiDriver.lng, latJemput, lngJemput);

          const card = document.createElement('div');
          card.className = 'order-card';
          card.innerHTML = `
            <img src="${o.photo_url || 'https://i.ibb.co/BBt4p4P/no-profile.png'}">
            <div class="order-info">
              <div class="alamat">${o.from}</div>
              <div class="nama">${o.userName}</div>
              <div class="order-footer">
                <span>${o.distance}</span>
                <span>${o.duration}</span>
                <span>Rp ${o.totalPrice}</span>
              </div>
            </div>
          `;
          orderList.appendChild(card);

          if (jarak <= 2 && (!orderDipilih || orderDipilih.id !== id)) {
            orderDipilih = { id, data: o };
            tampilkanBottomSheet(o);
          }
        }
      });
    }

    function tampilkanBottomSheet(o) {
      const sheet = document.getElementById('bottomSheet');
      const content = document.getElementById('sheetContent');
      const ringkasan = document.getElementById('ringkasanOrder');
      document.getElementById('fotoPenumpang').src = o.photo_url || 'https://i.ibb.co/BBt4p4P/no-profile.png';
      document.getElementById('namaPenumpang').textContent = o.userName;

      content.innerHTML = `
        <p class="from">${o.from}</p>
        <p>${o.to}</p>
        <p>Telp: ${o.phone}</p>
      `;
      ringkasan.innerHTML = `
        <span>${o.distance}</span>
        <span>${o.duration}</span>
        <span>Rp ${o.totalPrice}</span>
      `;

      const [latFrom, lngFrom] = o.from_latlng.split(',');
      const [latTo, lngTo] = o.to_latlng.split(',');
      const url = `https://www.google.com/maps/embed/v1/directions?key=${mapKey}&origin=${lokasiDriver.lat},${lokasiDriver.lng}&destination=${latTo},${lngTo}&waypoints=${latFrom},${lngFrom}&mode=driving&avoid=tolls`;

      if (url !== currentMapUrl) {
        document.getElementById('mapFrame').src = url;
        currentMapUrl = url;
      }

      sheet.style.display = 'block';
    }

    function batalkanOrder() {
      if (orderDipilih) {
        orderDibatalkan.add(orderDipilih.id);
      }
      document.getElementById('bottomSheet').style.display = 'none';
      orderDipilih = null;
      muatOrder();
    }

    function ambilOrder() {
      if (!orderDipilih) return;
      db.ref('orders/' + orderDipilih.id).update({ status: 'di_ambil' });
      if (window.AndroidInterface && window.AndroidInterface.setWebViewString) {
        window.AndroidInterface.setWebViewString("di_ambil");
      }
      document.getElementById('bottomSheet').style.display = 'none';
    }
  </script></body>
</html>
