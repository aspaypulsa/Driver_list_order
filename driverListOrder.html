<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver App - Daftar Order</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding-bottom: 80px;
        }
        
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .order-list {
            padding: 15px;
        }
        
        .order-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .profile-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .order-info {
            flex: 1;
        }
        
        .user-name {
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .pickup-address {
            font-weight: bold;
            margin-bottom: 8px;
            color: #222;
        }
        
        .order-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .no-orders {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error-message {
            color: #f44336;
            text-align: center;
            padding: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Daftar Order</h1>
    </div>
    
    <div class="order-list" id="orderList">
        <div class="loading">Memuat order...</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Debugging: Tampilkan pesan di console bahwa script berjalan
        console.log("Aplikasi driver mulai berjalan...");
        
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const firebaseConfigParam = urlParams.get('firebaseConfig');
        const mapKey = urlParams.get('mapKey');
        
        // Debugging: Tampilkan parameter yang diterima
        console.log("Parameter URL:", {
            firebaseConfig: firebaseConfigParam ? "Ada" : "Tidak Ada",
            mapKey: mapKey ? "Ada" : "Tidak Ada"
        });
        
        if (!firebaseConfigParam || !mapKey) {
            const errorMsg = !firebaseConfigParam && !mapKey 
                ? "Parameter firebaseConfig dan mapKey tidak ditemukan di URL." 
                : !firebaseConfigParam 
                    ? "Parameter firebaseConfig tidak ditemukan di URL." 
                    : "Parameter mapKey tidak ditemukan di URL.";
            
            document.getElementById('orderList').innerHTML = `
                <div class="error-message">${errorMsg}</div>
            `;
            console.error(errorMsg);
            throw new Error(errorMsg);
        }
        
        try {
            // Initialize Firebase
            const firebaseConfig = JSON.parse(decodeURIComponent(firebaseConfigParam));
            console.log("Firebase Config:", firebaseConfig);
            
            // Cek apakah Firebase sudah diinisialisasi
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase berhasil diinisialisasi");
            } else {
                firebase.app(); // Gunakan yang sudah ada
                console.log("Firebase sudah diinisialisasi sebelumnya");
            }
            
            const database = firebase.database();
            
            // Debugging: Coba baca data langsung dari root untuk testing
            database.ref().once('value')
                .then(snapshot => {
                    console.log("Data testing dari Firebase root:", snapshot.val());
                })
                .catch(error => {
                    console.error("Error testing Firebase connection:", error);
                });
            
            // Load orders
            loadOrders();
            
        } catch (error) {
            console.error("Error inisialisasi Firebase:", error);
            document.getElementById('orderList').innerHTML = `
                <div class="error-message">Gagal menginisialisasi Firebase: ${error.message}</div>
            `;
        }
        
        function loadOrders() {
            console.log("Memulai memuat orders...");
            
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '<div class="loading">Memuat order...</div>';
            
            const ordersRef = firebase.database().ref('orders');
            
            // Debugging: Tampilkan path yang digunakan
            console.log("Mengambil data dari path:", ordersRef.toString());
            
            ordersRef.orderByChild('status').equalTo('pending').once('value')
                .then(snapshot => {
                    const orders = snapshot.val();
                    console.log("Data order yang diterima dari Firebase:", orders);
                    
                    if (!orders || Object.keys(orders).length === 0) {
                        orderList.innerHTML = `
                            <div class="no-orders">
                                <p>Tidak ada order yang tersedia</p>
                            </div>
                        `;
                        return;
                    }
                    
                    renderOrders(orders);
                })
                .catch(error => {
                    console.error("Error memuat orders:", error);
                    orderList.innerHTML = `
                        <div class="error-message">
                            Gagal memuat data order. Silakan cek koneksi internet Anda.
                            <br><br>
                            Detail Error: ${error.message}
                        </div>
                    `;
                });
        }
        
        function renderOrders(orders) {
            console.log("Merender orders:", orders);
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '';
            
            Object.entries(orders).forEach(([orderId, order]) => {
                console.log("Memproses order:", orderId, order);
                
                // Validasi data order
                if (!order) {
                    console.warn("Order kosong:", orderId);
                    return;
                }
                
                const orderElement = document.createElement('div');
                orderElement.className = 'order-card';
                orderElement.dataset.orderId = orderId;
                
                // Data default jika field tidak ada
                const orderData = {
                    photo_url: order.photo_url || 'https://via.placeholder.com/60',
                    userName: order.userName || 'Pelanggan',
                    from: order.from || 'Alamat jemput tidak tersedia',
                    distance: order.distance || '0 km',
                    duration: order.duration || '0 menit',
                    totalPrice: order.totalPrice || 'Rp0'
                };
                
                orderElement.innerHTML = `
                    <img src="${orderData.photo_url}" class="profile-photo" alt="Profile">
                    <div class="order-info">
                        <div class="user-name">${orderData.userName}</div>
                        <div class="pickup-address">${orderData.from}</div>
                        <div class="order-meta">
                            <span>${orderData.distance}</span>
                            <span>${orderData.duration}</span>
                            <span>${orderData.totalPrice}</span>
                        </div>
                    </div>
                `;
                
                orderList.appendChild(orderElement);
            });
            
            console.log("Selesai merender orders");
        }
        
        // Tambahkan event listener untuk memuat ulang jika perlu
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded");
        });
    </script>
</body>
</html>
