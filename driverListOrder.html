<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Orderan Driver</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #f4f4f4; }
    header { padding: 10px; background-color: #004aad; color: white; text-align: center; font-size: 18px; }
    .order-card {
      background: white;
      margin: 10px;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    .profile { text-align: center; }
    .profile img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    .profile-name { font-size: 12px; margin-top: 4px; }
    .order-details { flex: 1; }
    .alamat { font-weight: bold; }
    .info-horizontal {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      font-size: 14px;
      color: #555;
    }
    #bottomSheet {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 999;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }
    #bottomSheet.show { transform: translateY(0); }
    #map { width: 100%; height: 60vh; border-radius: 12px; margin-bottom: 10px; }
    .sheet-header { display: flex; gap: 12px; align-items: center; }
    #sheetPhoto img { width: 60px; height: 60px; border-radius: 50%; }
    .profile-name { font-size: 14px; font-weight: bold; margin-top: 6px; }
    #closeSheet {
      margin-top: 12px;
      background: red;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 10px;
      width: 100%;
      font-size: 16px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #555;
    }
  </style>
</head>
<body>
  <header>Daftar Orderan</header>
  <div id="orderList">
    <div class="loading">Memuat data orderan...</div>
  </div>
  
  <div id="bottomSheet">
    <div id="map"></div>
    <div class="sheet-header">
      <div class="profile" id="sheetPhoto">
        <img src="">
        <div class="profile-name" id="sheetName">-</div>
      </div>
      <div>
        <div class="alamat" id="sheetFrom">Alamat Jemput</div>
        <div id="sheetTo">Alamat Antar</div>
      </div>
    </div>
    <div class="info-horizontal">
      <div id="sheetDistance">üåÉ 0 km</div>
      <div id="sheetDuration">‚è± 0 min</div>
      <div id="sheetHarga">üí∞ Rp0</div>
    </div>
    <button id="closeSheet">Tutup</button>
  </div>

  <script>
    // Variabel global
    let db, map, directionsService, directionsRenderer, driverLat, driverLng;
    const sheet = document.getElementById("bottomSheet");
    const orderList = document.getElementById("orderList");

    // Fungsi utama yang dijalankan saat halaman siap
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Ambil parameter URL
        const params = new URLSearchParams(location.search);
        const mapKey = params.get('mapKey');
        const firebaseConfig = JSON.parse(decodeURIComponent(params.get('firebaseConfig')));
        const driverID = params.get('driverID');
        const driverName = params.get('driverName');

        // Inisialisasi Firebase
        await initializeFirebase(firebaseConfig);
        
        // Muat Google Maps API
        await loadGoogleMaps(mapKey);
        
        // Dapatkan lokasi driver
        await getDriverLocation();
        
        // Muat data orderan
        await loadOrders();
      } catch (error) {
        console.error("Error:", error);
        orderList.innerHTML = `<div class="loading">Gagal memuat data: ${error.message}</div>`;
      }
    });

    // Fungsi untuk inisialisasi Firebase
    async function initializeFirebase(firebaseConfig) {
      // Muat script Firebase
      await loadScript(`https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js`);
      await loadScript(`https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js`);
      
      // Inisialisasi Firebase
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      
      console.log("Firebase initialized successfully");
    }

    // Fungsi untuk memuat Google Maps API
    async function loadGoogleMaps(mapKey) {
      await loadScript(`https://maps.googleapis.com/maps/api/js?key=${mapKey}`);
      initMap();
    }

    // Fungsi untuk mendapatkan lokasi driver
    function getDriverLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            driverLat = pos.coords.latitude;
            driverLng = pos.coords.longitude;
            console.log("Driver location:", driverLat, driverLng);
            resolve();
          },
          error => {
            console.error("Geolocation error:", error);
            reject(new Error("Tidak dapat mendapatkan lokasi Anda"));
          }
        );
      });
    }

    // Fungsi untuk memuat script
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`Gagal memuat script: ${src}`));
        document.head.appendChild(script);
      });
    }

    // Fungsi untuk inisialisasi peta
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: { lat: 1.52, lng: 124.85 },
        disableDefaultUI: true
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: false
      });
      console.log("Google Maps initialized");
    }

    // Fungsi untuk menampilkan bottom sheet
    function showBottomSheet(data) {
      try {
        document.getElementById("sheetPhoto").querySelector("img").src = data.photo_url || 'https://via.placeholder.com/70';
        document.getElementById("sheetName").innerText = data.userName || '-';
        document.getElementById("sheetFrom").innerText = data.from || '-';
        document.getElementById("sheetTo").innerText = data.to || '-';
        document.getElementById("sheetDistance").innerText = "üåÉ " + (data.distance || '0 km');
        document.getElementById("sheetDuration").innerText = "‚è± " + (data.duration || '0 min');
        document.getElementById("sheetHarga").innerText = "üí∞ Rp" + (data.totalPrice || '0');

        if (data.from_latlng && data.to_latlng) {
          const [fromLat, fromLng] = data.from_latlng.split(",");
          const [toLat, toLng] = data.to_latlng.split(",");
          const origin = new google.maps.LatLng(parseFloat(fromLat), parseFloat(fromLng));
          const destination = new google.maps.LatLng(parseFloat(toLat), parseFloat(toLng));

          directionsService.route({ origin, destination, travelMode: 'DRIVING' }, (response, status) => {
            if (status === 'OK') {
              directionsRenderer.setDirections(response);
            } else {
              console.error("Directions request failed:", status);
            }
          });
        }

        sheet.classList.add("show");
      } catch (error) {
        console.error("Error showing bottom sheet:", error);
      }
    }

    // Event listener untuk tombol tutup
    document.getElementById("closeSheet").addEventListener("click", () => {
      sheet.classList.remove("show");
    });

    // Fungsi untuk memuat data orderan
    function loadOrders() {
      orderList.innerHTML = '<div class="loading">Memuat data orderan...</div>';
      
      return new Promise((resolve, reject) => {
        try {
          db.ref("orders").on("value", (snapshot) => {
            try {
              if (!snapshot.exists()) {
                orderList.innerHTML = '<div class="loading">Tidak ada orderan tersedia</div>';
                resolve();
                return;
              }

              orderList.innerHTML = "";
              let hasOrders = false;

              snapshot.forEach((child) => {
                const data = child.val();
                if (data.status !== "pending") return;
                
                hasOrders = true;
                const card = document.createElement("div");
                card.className = "order-card";
                card.innerHTML = `
                  <div class="profile">
                    <img src="${data.photo_url || 'https://via.placeholder.com/50'}" />
                    <div class="profile-name">${data.userName || 'Tanpa Nama'}</div>
                  </div>
                  <div class="order-details">
                    <div class="alamat">${data.from || '-'}</div>
                    <div>${data.to || '-'}</div>
                    <div class="info-horizontal">
                      <div>üåÉ ${data.distance || '0'}</div>
                      <div>‚è± ${data.duration || '0'}</div>
                      <div>üí∞ Rp${data.totalPrice || '0'}</div>
                    </div>
                  </div>
                `;
                card.addEventListener("click", () => showBottomSheet(data));
                orderList.appendChild(card);
              });

              if (!hasOrders) {
                orderList.innerHTML = '<div class="loading">Tidak ada orderan tersedia</div>';
              }

              resolve();
            } catch (error) {
              console.error("Error processing orders:", error);
              orderList.innerHTML = '<div class="loading">Gagal memuat data orderan</div>';
              reject(error);
            }
          }, (error) => {
            console.error("Firebase error:", error);
            orderList.innerHTML = '<div class="loading">Gagal memuat data orderan</div>';
            reject(error);
          });
        } catch (error) {
          console.error("Error setting up Firebase listener:", error);
          orderList.innerHTML = '<div class="loading">Gagal memuat data orderan</div>';
          reject(error);
        }
      });
    }
  </script>
</body>
</html>
