<!DOCTYPE html><html>
<head>
  <meta charset="UTF-8">
  <title>Daftar Order Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f2f2f2; }
    h2 { background: #007bff; color: white; padding: 1em; text-align: center; margin: 0; }
    .toggle-container { padding: 1em; text-align: center; background: white; }
    .order-list { padding: 1em; }
    .order-card {
      background: white; border-radius: 12px; padding: 1em; margin-bottom: 1em;
      display: flex; align-items: flex-start; gap: 1em; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .order-card img {
      width: 64px; height: 64px; border-radius: 50%; object-fit: cover;
    }
    .order-info { flex: 1; }
    .order-info strong { display: block; font-weight: bold; margin-bottom: 0.3em; }
    .order-footer { display: flex; justify-content: space-between; margin-top: 0.5em; font-size: 0.9em; }
    .bottom-sheet {
      position: fixed; left: 0; right: 0; bottom: 0; background: white;
      border-radius: 20px 20px 0 0; padding: 1em; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      display: none; z-index: 10;
    }
    .map-container { width: 100%; height: 200px; margin: 1em 0; border-radius: 10px; overflow: hidden; }
    .bottom-sheet button { padding: 0.6em 1em; border: none; border-radius: 6px; margin-right: 1em; cursor: pointer; }
    .btn-batal { background: #dc3545; color: white; }
    .btn-ambil { background: #28a745; color: white; }
  </style>
</head>
<body>
  <h2>Daftar Order</h2>
  <div class="toggle-container">
    <label>
      <input type="checkbox" id="toggleAktif"> Tampilkan Order Aktif
    </label>
  </div>
  <div class="order-list" id="orderList">Memuat order...</div>  <div class="bottom-sheet" id="bottomSheet">
    <div id="sheetContent"></div>
    <div class="map-container">
      <iframe id="mapFrame" width="100%" height="100%" style="border:0" allowfullscreen loading="lazy"></iframe>
    </div>
    <button class="btn-batal" onclick="batalkanOrder()">Batalkan</button>
    <button class="btn-ambil" onclick="ambilOrder()">Ambil Order</button>
  </div>  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>  <script>
    const params = new URLSearchParams(location.search);
    const mapKey = params.get('mapKey');
    const config = JSON.parse(decodeURIComponent(params.get('firebaseConfig')));
    firebase.initializeApp(config);
    const db = firebase.database();

    let aktif = false;
    let lokasiDriver = null;
    let orderDipilih = null;

    document.getElementById('toggleAktif').addEventListener('change', e => {
      aktif = e.target.checked;
    });

    navigator.geolocation.watchPosition(pos => {
      lokasiDriver = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      if (aktif) muatOrder();
    });

    function haversine(lat1, lng1, lat2, lng2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function muatOrder() {
      db.ref('orders').once('value', snap => {
        const data = snap.val();
        const orderList = document.getElementById('orderList');
        orderList.innerHTML = '';
        for (const id in data) {
          const o = data[id];
          if (o.status !== 'pending') continue;
          const [latJemput, lngJemput] = o.from_latlng.split(',').map(Number);
          const jarak = haversine(lokasiDriver.lat, lokasiDriver.lng, latJemput, lngJemput);

          const card = document.createElement('div');
          card.className = 'order-card';
          card.innerHTML = `
            <img src="${o.photo_url || 'https://i.ibb.co/BBt4p4P/no-profile.png'}">
            <div class="order-info">
              <div style="text-align:center;margin-bottom:0.3em"><strong>${o.userName}</strong></div>
              <strong>${o.from}</strong>
              <div class="order-footer">
                <span>${o.distance}</span>
                <span>${o.duration}</span>
                <span>Rp ${o.totalPrice}</span>
              </div>
            </div>
          `;
          orderList.appendChild(card);

          if (jarak <= 2) {
            orderDipilih = { id, data: o };
            tampilkanBottomSheet(o);
          }
        }
      });
    }

    function tampilkanBottomSheet(o) {
      const sheet = document.getElementById('bottomSheet');
      const content = document.getElementById('sheetContent');
      content.innerHTML = `
        <p><strong>${o.userName}</strong></p>
        <p>${o.from}</p>
        <p>${o.to}</p>
        <p>Telp: ${o.phone}</p>
      `;
      const [latFrom, lngFrom] = o.from_latlng.split(',');
      const [latTo, lngTo] = o.to_latlng.split(',');
      const url = `https://www.google.com/maps/embed/v1/directions?key=${mapKey}&origin=${lokasiDriver.lat},${lokasiDriver.lng}&destination=${latTo},${lngTo}&waypoints=${latFrom},${lngFrom}`;
      document.getElementById('mapFrame').src = url;
      sheet.style.display = 'block';
    }

    function batalkanOrder() {
      document.getElementById('bottomSheet').style.display = 'none';
      orderDipilih = null;
    }

    function ambilOrder() {
      if (!orderDipilih) return;
      db.ref('orders/' + orderDipilih.id).update({ status: 'di_ambil' });
      if (window.AndroidInterface && window.AndroidInterface.setWebViewString) {
        window.AndroidInterface.setWebViewString("di_ambil");
      }
      document.getElementById('bottomSheet').style.display = 'none';
    }
  </script></body>
</html>
