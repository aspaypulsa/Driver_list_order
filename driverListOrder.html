<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver App - Daftar Order</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ... (CSS sebelumnya tetap sama) ... */
        
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            padding: 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: 80vh;
            overflow-y: auto;
            touch-action: none;
        }
        
        .bottom-sheet.active {
            transform: translateY(0);
        }
        
        .distance-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- ... (HTML sebelumnya tetap sama) ... -->

    <script>
        // ... (Script sebelumnya sampai init()) ...

        function init() {
            // Start watching position
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log("Posisi driver diperbarui:", currentPosition);
                        checkDistanceToOrders();
                    },
                    error => {
                        console.error('Error getting location:', error);
                        loadOrders(); // Tetap load orders meski geolocation error
                    },
                    { 
                        enableHighAccuracy: true,
                        maximumAge: 30000,
                        timeout: 10000 
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
                loadOrders();
            }
            
            // ... (Event listeners lainnya) ...
        }

        function checkDistanceToOrders() {
            if (!currentPosition) {
                console.log("Posisi driver belum tersedia");
                return;
            }
            
            console.log("Memeriksa jarak ke semua order...");
            
            ordersRef.orderByChild('status').equalTo('pending').once('value')
                .then(snapshot => {
                    const orders = snapshot.val();
                    if (!orders) return;
                    
                    Object.entries(orders).forEach(([orderId, order]) => {
                        if (!order.from_latlng) {
                            console.warn("Order tidak memiliki from_latlng:", orderId);
                            return;
                        }
                        
                        const fromLatLng = order.from_latlng.split(',');
                        const distance = calculateDistance(
                            currentPosition.lat,
                            currentPosition.lng,
                            parseFloat(fromLatLng[0]),
                            parseFloat(fromLatLng[1])
                        );
                        
                        console.log(`Jarak ke order ${orderId}: ${distance.toFixed(2)} km`);
                        
                        // Auto-open bottom sheet jika jarak < 2 km dan belum terbuka
                        if (distance < 2 && (!currentOrder || currentOrder.id !== orderId)) {
                            console.log(`Order ${orderId} dalam jarak dekat (${distance.toFixed(2)} km), membuka bottom sheet`);
                            currentOrder = { ...order, id: orderId };
                            openBottomSheet(order);
                        }
                    });
                })
                .catch(error => {
                    console.error("Error checking distances:", error);
                });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius bumi dalam km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Jarak dalam km
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // ... (Fungsi lainnya tetap sama) ...
    </script>
</body>
</html>
